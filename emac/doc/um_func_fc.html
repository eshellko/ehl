<html>
   <style> pre.small {line-height: 0.5; font-weight:bold; }</style>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Flow Control</title>
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
      <h2 class="title">Flow Control</h2>
      <hr>

	  <p>
	     <b>ehl_emac</b> поддерживает функцию Flow Control.
		 Управление функцией осуществляется с помощью регистров <b>FCVR</b> и <b>FCLR</b>.
		 Для активации функции следует установить <b>CFG.fce</b>.
		 Функция работает только в режиме Full Duplex.
	  </p>
	  <p>
	     Приемник контроллера содержит <b>RX_DESCR_COUNT</b> дескрипторов.
		 Если количество занятых дескрипторов превышает (или равно) значение <b>FCLR.HL</b>, контроллер автоматически отправляет PAUSE кадр со значением pause_time, записанным в <b>FCVR</b>.
		 Одновременно с этим контроллер запускает внутренний таймер с указанным в <b>FCVR</b> значением, чтобы отслеживать значение на другой стороне (в режиме Full Duplex по определению соединение имеет вид точка-точка).
	  </p>
	  <p>
	     Если количество занятых дескрипторов становится меньше (или равно) <b>FCLR.LL</b>, и внутренний таймер не равен 0, контроллер отправляет PAUSE кадр со значением pause_time равным 0.
		 Одновременно обнуляется внутренний таймер.
	  </p>
	  <p>
	     Если приемник получает PAUSE кадр, он записывает указанное в нем значение pause_time во внутренний счетчик.
		 Если значение счетчика отлично от 0, то передатчик контроллера прекращает все последующие попытки передачи.
		 Текущая передача заканчивается, если она была начата до приема (с учетом некоторой задержки на синхронизацию) PAUSE кадра.
		 Передатчик возобновляет передачу, если получен PAUSE кадр со значением pause_time, равным 0, или внутренний счетчик обнуляется.
	  </p>
	  <p>
	     В режиме Flow Control (<b>CR.fce</b> = b’1) eth_mac выполняет следующие действия:
	  </p>
	  <p>
	     При получении PAUSE кадра, адресованного по групповому адресу 0x01:80:C2:00:00:01 (если установлен <b>RxCR.dp</b>) или по индивидуальному MAC адресу (регистр <b>MAC Address</b>) приостанавливается работа передатчика.
		 Передатчик заканчивает текущую передачу, если она была начата, и ожидает время, указанное в принятом PAUSE кадре.
		 На время приостановки работы передатчика устанавливается <b>TxSR.tp</b>.
	  </p>
	  <p>
	     При превышении числа заполненных в буфере приемника ячеек значения <b>FCHLR</b> отправляется PAUSE кадр, содержащий значение <b>FCVR</b>.
		 Если значение заполненных ячеек становится меньше <b>FCLLR</b> и, предположительно (<b>ehl_emac</b> проводит отсчет значения паузы, отправленного в PAUSE кадре; значения отсчета у <b>ehl_emac</b> и станции-приемника могут не совпадать), станция на противоположенной стороне не отсчитала указанное в ранее отправленном кадре значение, то отправляется PAUSE кадр, содержащий значение 0x0.
	  </p>
	  <p>
	     PAUSE кадр отправляется только при превышении <b>FCHLR</b> при получении корректного кадра (при этом PAUSE кадр корректным не считается).
		 Если значение <b>FCHLR</b> было обновлено и превышает число заполненных в буфере приемника ячеек, кадр будет отправлен только после получения следующего корректного кадра.
	  </p>

      <p><a name="FCVR"></a><span class="bold" style="color: #0000CC"><b>FCVR [0x004]: </b></span>Значение паузы Flow Control</p>
      <table cellpadding="1" width="90%" border="1" cellspacing="0" rules="all">
         <colgroup><col><col><col><col><col></colgroup>
         <thead>
            <tr bgcolor="#C0C0C0">
               <th>Биты</th>
               <th>Название</th>
               <th>Описание</th>
               <th>Доступ</th>
               <th>Начальное значение</th>
            </tr>
         </thead>
         <tbody>
            <tr>
               <td>31:16</td>
               <td>-</td>
               <td><b>Резерв</b></td>
               <td>R</td>
               <td>0</td>
            </tr>
            <tr>
               <td>15:0</td>
               <td>-</td>
               <td>Определяет значение паузы, необходимой для освобождения места в буфере приемника, в течение которой передатчик на другой стороне сети должен не передавать данные.</td>
               <td>R/W/SC</td>
               <td>0</td>
            </tr>
         </tbody>
      </table>

      <p><a name="FCLR"></a><span class="bold" style="color: #0000CC"><b>FCLR [0x104]: </b></span>Коэффициенты Flow Control</p>
      <table cellpadding="1" width="90%" border="1" cellspacing="0" rules="all">
         <colgroup><col><col><col><col><col></colgroup>
         <thead>
            <tr bgcolor="#C0C0C0">
               <th>Биты</th>
               <th>Название</th>
               <th>Описание</th>
               <th>Доступ</th>
               <th>Начальное значение</th>
            </tr>
         </thead>
         <tbody>
            <tr>
               <td>31:16</td>
               <td>HL</td>
               <td>Определяет количество занятых ячеек в буфере приемника, при достижении которого отправляется PAUSE кадр.</td>
               <td>R/W</td>
               <td>TX_BUFFER_SIZE-1</td>
            </tr>
            <tr>
               <td>15:0</td>
               <td>LL</td>
               <td>Определяет количество занятых ячеек в буфере приемника, при достижении которого отправляется PAUSE кадр, с отменой предыдущего запроса на паузу.</td>
               <td>R/W</td>
               <td>(TX_BUFFER_SIZE/2)-1</td>
            </tr>
         </tbody>
      </table>

   </body>
</html>
