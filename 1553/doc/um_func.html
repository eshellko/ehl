<html>
   <style> pre.small {line-height: 0.5;}</style>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Функционирование</title>
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
      <h2>Функционирование</h2>
<!--
<pre class="small">|------|------|   |------|</pre>
<pre class="small">|  CW  |  DW  |   |  SW0 |</pre>
<pre class="small">|------|------|   |------|</pre>
-->
      <p><b>EHL_M1553</b> предназначен для работы с шиной Mil-Std 1553B.</p>
      <p><b style="color: #FF0000">Примечание</b>. Далее принимается следующая терминология:</p>
	  <ul>
         <li><b style="color: #FF0000">Слово</b> - 3-символьная преамбула + 16-битная последовательность + бит четности, переданные (или предназначенные для передачи) по шине.</li>
         <li><b style="color: #FF0000">Сообщение</b> - одно или более слово, переданное по шине, составляющие единую структуру.</li>
         <li><b style="color: #FF0000">Задание</b> - команда передать определенное сообщение по шине, включающая повторную передачу сообщения в случае возникновения ошибок.</li>
	  </ul>
      <p>
         Управление режимами работы контроллера, запуск выполнения заданий и работа с прерываниями осуществляется через регистры блока (интерфейс APB).
         Обмен данными, дескрипторами заданий и результатами их выполнения осуществляется через внешнюю память, доступную блоку через порт AHB.
      </p>
      <p>Контроллер может быть сконфигурирован для работы в режиме <a href="um_func_bc.html" class="olink">Bus Controller</a> или <a href="um_func_rt.html" class="olink">Remote Terminal</a>. Параллельно с ними контроллер может быть включен в режиме <a href="um_func_bm.html" class="olink">Bus Monitor</a>.</p>
      <p>
         Поскольку обмен данными в Mil-Std 1553 происходит с помощью 16-битных слов, то их размещение в памяти соответствует следующему принципу:
            первое принятое 16-битное слово размещается по меньшему адресу,
            второе слово имеет адрес +2 относительно первого слова.
         Такое поведение противоречит [3 4.3.2]: "...the most significant bits shall be transmitted first, followed by the word(s) containng the lesser significant bits...", но может быть исправлено прогарммно.
      </p>

      <h2><a name="REGS"></a>Регистры контроллера</h2>
      <table summary="Registers for Address Block: ehl_m1553" cellpadding="4" width="0%" border="1" cellspacing="0" rules="all">
         <colgroup><col><col><col></colgroup>
         <thead>
            <tr bgcolor="#C0C0C0">
               <th>Регистр</th>
               <th>Адрес</th>
               <th>Описание</th>
            </tr>
         </thead>
         <tbody>
            <tr> <td><a href="reg_desc.html#Config"       class="olink">CFG</a></td>           <td>0x00</td> <td>Регистр настройки</td> </tr>
            <tr> <td><a href="reg_desc.html#BC_ADDR"      class="olink">BC_ADDR</a></td>       <td>0x04</td> <td>Регистр настройки адреса задания КШ</td> </tr>
            <tr> <td><a href="reg_desc.html#Control"      class="olink">CTRL</a></td>          <td>0x08</td> <td>Регистр управления</td> </tr>
            <tr> <td><a href="reg_desc.html#Time"         class="olink">TIME</a></td>          <td>0x0C</td> <td>Регистр настройки таймера</td> </tr>
            <tr> <td><a href="reg_desc.html#LStatus"      class="olink">LSTAT</a></td>         <td>0x10</td> <td>Регистр статуса последнего завершенного сообщения</td> </tr>
            <tr> <td><a href="reg_desc.html#BM_ADDR_INIT" class="olink">BM_ADDR_INIT</a></td>  <td>0x14</td> <td>Начальный адрес буфера МШ</td> </tr>
            <tr> <td><a href="reg_desc.html#BM_ADDR_LAST" class="olink">BM_ADDR_LAST</a></td>  <td>0x18</td> <td>Конечный адрес буфера МШ</td> </tr>
            <tr> <td><a href="reg_desc.html#BM_ADDR_IRQ"  class="olink">BM_ADDR_IRQ</a></td>   <td>0x1C</td> <td>Адрес генерации прерывания МШ</td> </tr>
            <tr> <td><a href="reg_desc.html#BM_ADDR_CUR"  class="olink">BM_ADDR_CUR</a></td>   <td>0x20</td> <td>Адрес следующей ячейки, записываемой МШ</td> </tr>
            <tr> <td><a href="reg_desc.html#BM_TIMER"     class="olink">BM_TIMER</a></td>      <td>0x24</td> <td>Регистр таймера МШ</td> </tr>
            <tr> <td><a href="reg_desc.html#RT_MCC"       class="olink">RT_MCC</a></td>        <td>0x28</td> <td>Регистр маскирования команд удаленному терминалу</td> </tr>
            <tr> <td><a href="reg_desc.html#RT_CFG"       class="olink">RT_CFG</a></td>        <td>0x2C</td> <td>Регистр настройки удаленного терминала</td> </tr>
            <tr> <td><a href="reg_desc.html#RT_ADDR"      class="olink">RT_ADDR</a></td>       <td>0x30</td> <td>Регистр настройки адреса дескрипторов ОУ</td> </tr>
            <tr> <td><a href="reg_desc.html#IRQ_ena"      class="olink">IRQ_ENA</a></td>       <td>0x34</td> <td>Регистр разрешения прерываний</td> </tr>
            <tr> <td><a href="reg_desc.html#IRQ_flag"     class="olink">IRQ_FLAG</a></td>      <td>0x38</td> <td>Регистр флагов прерываний</td> </tr>
            <tr> <td><a href="reg_desc.html#REV"          class="olink">REVISION</a></td>      <td>0x3C</td> <td>Регистр версии контроллера</td> </tr>
         </tbody>
      </table>

      <h2><a name="IRQ"></a>Прерывания</h2>
      <p>
         <b>ehl_m1553</b> позволяет генерировать прерывания для сигнализации различных событий.
         Для разрешения генерации прерывания следует установить соответствующее ему разрешение в регистре <b>IRQ_ENA</b>.
         Тип прерывания зависит от режима работы контроллера.
      </p>
      <p>
         Для всех режимов работы характерно прерывание от DMA.
         Для получения заданий, чтения и записи данных, контроллер использует AHB DMA.
         В случае получения ошибочного отклика по шине AHB, поступлении следующей команды с шины, или отсутствия отклика в течение длительного периода времени (120 тактов <b>ref_clk</b>), генерируется прерывание.
      </p>

      <h4>Контроллер Шины</h4>
      <p>
         Контроллер позволяет использовать прерывания для сигнализации завершения выполнения заданий.
         Выбор задания, по которому генерируется прерывание задается в дескрипторе задания (для BC <b>Config.IOE</b>, <b>Config.IOC</b>).
         При выполнении условия генерации прерывания происходит установка флага прерывания в регистре <b>IRQ_FLAG</b> и генерация внешнего прерывания на выводе <b>irq</b> контроллера.
         Для сброса флага прерывания следует записать 1 в соответствующий разряд <b>IRQ_FLAG</b>.
         Если одновременно со сбросом флага прерывания сгенерируется новое прерывание, оно будет сохранено в регистре флагов прерываний.
      </p>
      <h4>Оконечное Устройство</h4>
      <p>
	  Контроллер позволяет генерировать прерывания при получении следующих команд: Dynamic Bus Control, Reset Remote Terminal и Synchronize.
	  Прерывание генерируется при завршении команды приема.
	  Обработка флагов прерываний идентична режиму КШ.
      </p>
      <h4>Монитор Шины</h4>
      <p>
	  Контроллер позволяет генерировать прерывание при совпадении адреса, по которому МШ пишет данные с запрограммированным.
	  Это позволяет отслеживать заполненность буфера и обеспечить непрерываность его использования.
      </p>

      <p>
      </p>
      <p>
         Для Bus Controller прерывание управляется битами <b>IRQ_ENA.BCED</b> и <b>IRQ_FLAG.BCID</b>.
         Задание, при выполнении которого возникла ошибка DMA прекращается, также как и все последующие задания. Статус дескриптора не обновляется (ввиду потенциальных ошибок DMA).
      </p>


      <p>
         Bus Controller начинает передачу, убедившись, что линия не занята.
         Чтобы проверить занятость линии при использовании внешнего трансивера следует установить RXEN (иначе принимаются неактивные состояния).
         Таким образом, любое лишнее слово на шине приемника не будет детектировано как занятая линия. Т.е. проверку следует проводить разрешив прием, подождав некоторое время (необходимое для детектирования активности) и проверив статус.
         В то же время активность детектируется наличием переключений, и при ключении в случайный момент, принимаемые данные могут быть незадетектированы сразу (но линия занята).
      </p>
      <p>
         Данный вид проверки остается на откуп пользователю. Приемник будет генерировать LOOP_ERROR в данном случае.
      </p>

   </body>
</html>
