<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Режим оконечного устройства</title>
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
      <h2>Режим оконечного устройства</h2>
      <p>
         В данном режиме (<b>CFG.MS</b>=0) контроллер начинает работу с шиной после записи 1 в <b>CFG.BE</B>.
         Контроллер проверяет поступающие команды на предмет совпадения адреса с <b>RT_CFG.RTA</b> (или совпадение с широковещательным адресом при установленном <b>RT_CFG.BE</b>).
         Команды адресуемые контроллеру проверяются на предмет поддерживаемого значения субадреса и обрабатываются. В случае неподдерживаемого субадреса происходит сигнализация Message Error.
      </p>

      <p><b style="color: #FF0000">Замечание</b>.
	     Согласно [3 4.3.3.5.4] ОУ должно сбросить статусное слово после приема валидного CW за исключением 4.3.3.5.1.7.
		 В 4.3.3.5.1.7 говорится об опциональных кодах, которые согласно стандарту трактуются как валидные (если не было протокольных ошибок), но нелегальные.
		 Такое ограничение вносит неясность в процедуру детектирования ОУ приема невалидной команды, поэтому <b>ehl_m1553</b>
		    сбрасывает статусное слово при приеме всех валидных команд (легальных и нелегальных), за исключением TRANSMIT STATUS WORD и TRANSMIT LAST COMMAND.
      </p>

      <h3>Отключение передатчика</h3>
      <p>
         Передатчик ОУ может быть отключен на основной или дублирующей шине.
         Если команда TRANSMITTER_SHUTDOWN поступила по шине A, то будет отключен передатчик на шине B.
         Если команда поступила по шине B, то будет отключен передатчик на шине A.
         При это повторная попытка отключить передатчик будет приводить к STATUS_WORD.MESSAGE_ERROR = 1.
         После получения команды отключения передатчика, ОУ перестает принимать команды по отключенной шине. Это позволяет избежать отключения активной шины.
      </p>

      <h2><a name="DESCR"></a>Дескрипторы</h2>
      <p>
         Обработка команд приема/передачи данных в контроллере (в режиме ОУ) происходит в соответствии со значениями дескрипторов, расположенных в памяти по адресу, задаваемому в <b>RT_ADDR</b>.
         Дескрипторы содержат настройки устройства для заданного субадреса (<b>Config</b>), состояние (<b>Descriptor</b>), а также указатели на буферы чтения и записи.
         Перед началом работы с ОУ необходимо проинициализировать таблицу дескрипторов.
      </p>
<!-- TODO: check if align to 32 -->
      <p>Data Buffer Pointer должен быть выровнен до границы 2 байта, т.е. младший разряд адреса должен быть равен 0.
      </p>
      <img src="um_rt_desc.png" width="70%">
<!-- TODO: add table format -->

      <p><a name="Config"></a><span class="bold" style="color: #0000CC"><b>Config [0x0]: </b></span>Настройка дескриптора субадреса</p>
      <p>
         В случае получения команды, адресуемой субадресу с отключенной поддержкой данного типа транзакции (<b>RXEN</b> или <b>TXEN</b>) или неподдерживаемым размером транзакции (<b>RXSZ</b> иди <b>TXSZ</b>) в STATUS слове будет установлен бит MESSAGE_ERROR, содержимое передаваемых данных следует считать невалидным.
      </p>
      <table summary="Fields for Register: desc_cfg" cellpadding="1" width="0%" border="1" cellspacing="0" rules="all">
         <colgroup><col><col><col></colgroup>
         <thead>
            <tr bgcolor="#C0C0C0">
               <th>Биты</th>
               <th>Название</th>
               <th>Описание</th>
            </tr>
         </thead>
         <tbody>
            <tr>
               <td>31:18</td>
               <td>-</td>
               <td><b>Резерв</b></td>
            </tr>
<!-- wraparound enable -->
            <tr>
               <td>17</td>
               <td>IGNDV</td>
               <td><b>Ignore Data Valid</b>. Игнорировать флаг <b>Data Valid</b> дескриптора буфера при записи в него.</td>
            </tr>
            <tr>
               <td>16</td>
               <td>BCRXEN</td>
               <td><b>Broadcast Receive Enable</b>. Разрешение приема широковещательных команд для выбранного субадреса.</td>
            </tr>
            <tr>
               <td>15</td>
               <td>RXEN</td>
               <td><b>Receive Enable</b>. Разрешение обработки команд приема для выбранного субадреса.</td>
            </tr>
            <tr>
               <td>14</td>
               <td>-</td>
<!-- TODO: log receive transfers -->
               <td><b>Резерв</b></td>
            </tr>
            <tr>
               <td>13</td>
               <td>RXIRQ</td>
               <td><b>Receive IRQ</b>. Разрешение прерывания по окончании приема:<li>0 - запрещено;</li><li>1 - разрешено.</li></td>
            </tr>
            <tr>
               <td>12:8</td>
               <td>RXSZ</td>
               <td><b>Receive Size</b>. Максимальный поддерживаемый размер приема (в 16-битных словах) для выбранного субадреса. Значение 0 соответствует 32 словам.</td>
            </tr>
            <tr>
               <td>7</td>
               <td>TXEN</td>
               <td><b>Transmit Enable</b>. Разрешение обработки команд передачи для выбранного субадреса.</td>
            </tr>
            <tr>
               <td>6</td>
               <td>-</td>
<!-- log transmit trasnfer in event log ring-->
               <td><b>Резерв</b></td>
            </tr>
            <tr>
               <td>5</td>
               <td>TXIRQ</td>
               <td><b>Transmit IRQ</b>. Разрешение прерывания по окончании передачи:<li>0 - запрещено;</li><li>1 - разрешено.</li></td>
            </tr>
            <tr>
               <td>4:0</td>
               <td>TXSZ</td>
               <td><b>Transmit Size</b>. Максимальный поддерживаемый размер передачи (в 16-битных словах) для выбранного субадреса. Значение 0 соответсвует 32 словам.</td>
            </tr>
         </tbody>
      </table>

      
      
      <p><a name="Descriptor"></a><span class="bold" style="color: #0000CC"><b>Descriptor: </b></span>Дескриптор буфера. Заполняется по окончании выполнения команды на шине.</p>
      <table summary="Fields for Register: desc_rt" cellpadding="1" width="0%" border="1" cellspacing="0" rules="all">
         <colgroup><col><col><col></colgroup>
         <thead>
            <tr bgcolor="#C0C0C0">
               <th>Биты</th>
               <th>Название</th>
               <th>Описание</th>
            </tr>
         </thead>
         <tbody>
            <tr>
               <td>31</td>
               <td>DV</td>
               <td><b>Data Valid</b>. Записывается 1 при заполнении буфера контроллером. Должен быть записан 0 программно перед использованием буфера. Запись в заполненный буфер не производится, если только не сброшен <b>CONFIG.IGNDV</b>.</td>
            </tr>
            <tr>
               <td>30:10</td>
               <td>-</td>
               <td><b>Резерв</b>.</td>
            </tr>
            <tr>
               <td>9</td>
               <td>BC</td>
               <td><b>Broadcast</b>. Записывается, в случае широковщательного трансфера.</td>
            </tr>
            <tr>
               <td>8</td>
               <td>BUS</td>
               <td>Шина, по которой пришло сообщение: 0 - bus A; 1 - bus B.</td>
            </tr>
            <tr>
               <td>7:3</td>
               <td>SZ</td>
               <td><b>Size</b>. Количество 16-битных слов в команде (0 соответствует 32 словам). Значение поля не валидно в случае Supersed. <!--TODO: allow to write 0 here for such cases--></td>
            </tr>
            <tr>
               <td>2:0</td>
               <td>TRES</td>
<!-- TODO: do we need to report received data to disabled SA as some BAD command!? -->
               <td><b>Transfer Result</b>. Результат выполнения команды:
                  <li>0 - успешно;</li>
                  <li>1 - команда прекращена в связи с поступлением новой команды (supersed);</li>
                  <li>2 - ошибка DMA - дескриптор не прочитан до поступления следующего слова по шине;</li>
                  <li>3 - ошибка протокола;</li>
                  <li>4 - ошибка протокола верхнего уровня (доступ к shutdown устройству, несоответствие между содержимым команд в RT2RT);</li>
                  <li>7 - ошибка в петле обратной связи - принимаемые данные отличны от передаваемых.</li>
               </td>
            </tr>
         </tbody>
      </table>
      <h3>Режим Data Wrap-around</h3>
      <p>
	     Согласно [6 30.7] ОУ должно реализовать механизм Data Wrap-around. <b>ehl_m1553</b> не имеет специального оборудования для поддержки указанного функционала.
		 Тем не менее он может быть реализован программно. Для этого следует настроить субадрес 30 с одним и тем же адресом буфера для приема и передачи сообщений.
		 Сам буфер при этом должен работать в циклическом режиме. Такая настройка позволяет читать из ОУ те же данные, которые только что были в него записаны.
      </p>

   </body>
</html>
