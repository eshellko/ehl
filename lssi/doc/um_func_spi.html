<html>
   <style> pre.small {line-height: 0.5; font-weight:bold; color: #FF00FF; }</style>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Функционирование (SPI)</title>
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
   <h2>Функционирование (SPI)</h2>

   <p>
      Здесь и далее под трансфером понимается передача данных из буфера <b>fifo_tx</b> на выход <b>MOSI</b>/<b>MISO</b> и прием данных с <b>MISO</b>/<b>MOSI</b> в буфер <b>fifo_rx</b>.
      Прием и передача происходят одновременно с использованием тактового сигнала для ведомого устройства <b>SCK</b>.
   </p>
   <p>
      Выбор режима трансфера осуществляется через регистр конфигурирования <b>CFG</b>.
      Разрешение работы задается в регистре <b>CTRL</b>.
      Управление выбором ведомого устройства осуществляется через регистр <b>TSR</b>.
      Отслеживание заполнения буферов осуществляется через регистр состояния <b>FSR</b>.
   </p>

   <h3>Фаза и полярность трансфера</h3>
   <p>
      Биты <b>CFG.PHA</b> и <b>CFG.POL</b> определяют фазу и полярность тактового сигнала при трансфере.
      Соотношение сигналов <b>MOSI</b>/<b>MISO</b> и <b>SCK</b> для режимов Controller и Target идентично.
   </p>
   <table summary="spi_modes" cellpadding="4" width="0%" border="1" cellspacing="0" rules="all">
      <colgroup><col><col><col></colgroup>
      <thead>
         <tr bgcolor="#C0C0C0"> <th>CFG.POL</th> <th>CFG.PHA</th> <th>Описание</th> </tr>
      </thead>
      <tbody>
         <tr> <td>0</td> <td>0</td> <td><p>В отсутствии трансфера <b>SCK</b>=b'0.</p><p>Данные выдвигаются по падающему фронту <b>SCK</b>, захватываются по нарастающему фронту <b>SCK</b>.</p></td> </tr>
         <tr> <td>0</td> <td>1</td> <td><p>В отсутствии трансфера <b>SCK</b>=b'0.</p><p>Данные выдвигаются по нарастающему фронту <b>SCK</b>, захватываются по падающему фронту <b>SCK</b>.</p></td> </tr>
         <tr> <td>1</td> <td>0</td> <td><p>В отсутствии трансфера <b>SCK</b>=b'1.</p><p>Данные выдвигаются по нарастающему фронту <b>SCK</b>, захватываются по падающему фронту <b>SCK</b>.</p></td> </tr>
         <tr> <td>1</td> <td>1</td> <td><p>В отсутствии трансфера <b>SCK</b>=b'1.</p><p>Данные выдвигаются по падающему фронту <b>SCK</b>, захватываются по нарастающему фронту <b>SCK</b>.</p></td> </tr>
      </tbody>
   </table>

   <p>&nbsp;</p>
   <img src="um_mode.png" width="70%">
   <p>&nbsp;</p>

   <p><a name="TSR"></a><b style="color: #0000CC">TSR [0x03] : </b>Регистр управления сигналами выбора Target.</p>
   <table summary="Fields for Register: TSR" cellpadding="4" width="100%" border="1" cellspacing="0" rules="all">
      <colgroup><col><col><col><col><col></colgroup>
      <thead>
         <tr bgcolor="#C0C0C0">
            <th>Биты</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Доступ</th>
            <th>Начальное значение</th>
         </tr>
      </thead>
      <tbody>
         <tr>
            <td>7:1</td>
            <td>TS</td>
            <td>
               <p><b>Target Select</b>. Выбор Target устройства, связанного с данным битом регистра.</p>
               <p>Акутальное количество бит определяется параметром <b>TS_WIDTH</b>. В случае отсутствия бита, значение равно 0.</p>
            </td>
            <td>R/W</td>
            <td>0x7F</td>
         </tr>
         <tr>
            <td>0</td>
            <td>TS0</td>
            <td>
               <p><b>Target Select 0</b>. При записи аналогичен старшим битам регистра. При чтении в режиме Controller (<b>CFG.SM</b>=b'0) равен записанному в нему значению, в режиме Target равен значению на выводе <b>ts0_cts_i</b> с учетом задержки на синхронизацию.</p>
			  <li>0 - Устройство активно в режиме Target;</li>
			  <li>1 - устройство неактивно в режиме Target.</li>
            </td>
            <td>R/W</td>
            <td>1</td>
         </tr>
      </tbody>
   </table>

   <h3>Режим Controller</h3>
   <p>
      Трансфер через SPI осуществляется, если в буфере передатчика находятся данные (<b>FSR.TxEmpty</b>=b'0), и разрешена передача (<b>CTRL.TE</b>=b'1).
      Начало трансфера сигнализируется установкой бита <b>STAT.TIP</b>.
      Когда последний байт из буфера <b>fifo_tx</b> переписывается в передатчик <b>spi_controller</b>, устанавливается бит <b>FSR.TxEmpty</b>.
      Трансфер заканчивается после передачи последнего байта, бит <b>STAT.TIP</b> сбрасывается.
   </p>
   <p>
      Изменение значения <b>CFG.PHA</b>, <b>CFG.POL</b> и <b>CFG.TBO</b> в процессе трансфера может привести к неправильному функционированию устройства.
   </p>
   <p>
      Трансфер может быть приостановлен сбросом <b>CTRL.TE</b>.
      Вне зависимости от момента сброса, передача текущего байта (если она была начата) будет завершена, а следующая передача не начнется до установки бита <b>CTRL.TE</b>.
   </p>
<pre class="small">                     __    __    __    __    __    __    __    __       __    __    __    __    __    __    __    __       </pre>
<pre class="small"> SCK         : _____|  |__|  |__|  |__|  |__|  |__|  |__|  |__|  |_____|  |__|  |__|  |__|  |__|  |__|  |__|  |__|  |______</pre>
<pre class="small">                                                            _____     ____       _____       ___________       _____       </pre>
<pre class="small"> MOSI        : ____________________________________________|     |___|    |_____|     |_____|           |_____|     |______</pre>
<!-- <pre class="small">                  _____ _____ _____ _____ _____ _____ _____ _____                                                          </pre> -->
<!-- <pre class="small"> MOSI        : --X_____X_____X_____X_____X_____X_____X_____X_____X---------------------------------------------------------</pre> -->
<pre class="small">               ______________________                                ______________________________________________________</pre>
<pre class="small"> CTRL.TE     :                       \______________________________/                                                      </pre>
<pre class="small">               __                                                     _____________________________________________________</pre>
<pre class="small"> FSR.TxEmpty :   \___________________________________________________/                                                     </pre>

   <h3>Режим Target</h3>
   <p>
      Для активации устройства в режиме Target (<b>CFG.SM</b>=b'1) требуется перевести вход <b>ts0_cts_i</b> в состояние b'0.
      В этот момент на выход <b>MISO_o</b> выставляется первый бит передаваемого пакета (в соответствии со значением <b>CFG.TBO</b>).
      Начинается опрос линии <b>SCK_i</b> до момента обнаружения фронта сигнала (в соответствии со значениями фазы и полярности).
      Опрос линии происходит через фильтр с частотой <b>rclk</b> путем выборки из 4 значений, поэтому частота <b>SCK</b> не должна превышать частоту <b>rclk</b>/4.
<!--      Q: if x8 ratio of frequencies?-->
      После обнаружения тактового сигнала происходит установка бита <b>STAT.TIP</b>.
      Сброс бита происходит после 8-го перепада на <b>SCK_i</b> или после установки <b>ts0_cts_i</b> (в зависимости от того, что произойдет раньше).
      Данные сдвигаются последовательно, после сдвига последнего бита байта, происходит чтение нового байта из буфера передатчика.
   </p>
   <p>
      Т.к. через SPI нельзя определить заполнение буфера передатчика, то контроль за этим полностью возложен на пользователя.
   </p>
   <p>
      Перевод <b>ts0_cts_i</b> в состояние b'1 в процессе трансфера приводит к окончанию передачи байта.
      После сброса <b>ts0_cts_i</b> передаваться будет уже следующий байт, прочитанный из <b>fifo_tx</b>.
   </p>

   </body>
</html>
