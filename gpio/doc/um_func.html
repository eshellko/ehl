<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Функционирование</title>
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
     <div class="article">
         <div class="titlepage">
            <h2 class="title">Функционирование</h2>
         </div>
      </div>
      <h3>Основные возможности</h3>
      <li> Динамическая конфигурация направления передачи данных для каждого из выводов;</li>
      <li> Динамическая конфигурация притяжек к "земле" и "питанию";</li>
      <li> Generic интерфейс со стороны пользователя;</li>
      <li> Настройка режимов побитового доступа (установка, сброс, инверсия) отдельно для каждого регистра;</li>
      <li> Маскируемая генерация прерываний по изменению состояний выводов.</li>

      <h3>Области применения</h3>
      <li> Контроллеры общего назначения;</li>
      <li> LED индикаторы;</li>
      <li> Мониторинг кнопок и переключателей;</li>
      <li> Клавиатуры портативных устройств.</li>

      <p>Управление <b>GPIO</b> осуществляется путем управления регистрами блока. Побитовый доступ к регистрам может быть осуществлен при использовании входа <b>addr[1:0]</b>. Его значение определяет тип доступа. Если <b>GPIO</b> содержит меньшее количество бит, чем 32, то старшие биты игнорируются. Чтение из регистров побитового доступа возвращает 0. Запись в регистры побитового доступа приводит к модернизации основных регистров.</p>

      <table summary="addr_map" cellpadding="4" width="0%" border="1" cellspacing="0" rules="all"><a name="GPIO_REGS"></a>
         <colgroup><col><col><col><col><col><col><col><col></colgroup>
         <thead>
            <tr bgcolor="#C0C0C0">
               <th>Имя</th>
               <th>addr[5:2]</th>
               <th>addr[1:0]</th>
               <th>Размер</th>
               <th>Доступ</th>
               <th>Начальное значение</th>
               <th>Описание</th>
            </tr>
         </thead>
         <tbody>
            <tr> <td>GDOR</td> <td>0x0</td> <td rowspan="11"><p>0x0 - read/write,</p> <p>0x1 - set,</p> <p>0x2 - clear,</p> <p>0x3 - invert.</p></td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GDOR_INIT</td> <td>Выходной регистр данных</td> </tr>
            <tr> <td>GOER</td> <td>0x1</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GOER_INIT</td> <td>Разрешение выходных данных</td> </tr>
            <tr> <td>GAFR</td> <td>0x2</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GAFR_INIT</td> <td>Разрешение альтернативной функции</td> </tr>
            <tr> <td>GPER</td> <td>0x3</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GPER_INIT</td> <td>Разрешение притяжки</td> </tr>
            <tr> <td>GPTR</td> <td>0x4</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GPTR_INIT</td> <td>Выбор типа притяжки</td> </tr>
            <tr> <td>GIER</td> <td>0x5</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GIER_INIT</td> <td>Разрешение прерывания</td> </tr>
            <tr> <td>GISR</td> <td>0x6</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GISR_INIT</td> <td>Тип источника прерывания</td> </tr>
            <tr> <td>GIFR</td> <td>0x7</td> <td>WIDTH</td> <td>R/C</td> <td>GIFR_INIT</td> <td>Флаг прерывания</td> </tr>
            <tr> <td>GDIR</td> <td>0x8</td> <td>WIDTH</td> <td>R</td> <td>-</td> <td>Входной регистр данных</td> </tr>
            <tr> <td>GCMR</td> <td>0x9</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GCMR_INIT</td> <td>Режим генерации прерывания</td> </tr>
            <tr> <td>GFMR</td> <td>0xA</td> <td>WIDTH</td> <td>R/W/S/C/I</td> <td>GFMR_INIT</td> <td>Режим фильтрации входных данных</td> </tr>
         </tbody>
      </table>

      <p>Доступность регистра по чтению определяется параметром <b>READ_*_ENA</b> (<b>*_ENA[1]</b>) для соответствующего регистра.</p>
      <p>Если применение <b>GPIO</b> не требует наличия какого-либо из регистров, то для него следует задать параметр <b>*_ENA</b> равными 0.</p>
      <p>Каждый разряд регистра отвечает за конфигурацию соответствующего ему разряда вывода <b>GPIO</b>.</p>
      <p><b>GDOR</b>: выходной регистр данных (вывод <b>gpio_out</b>) содержит данные для передачи в I/O.</p>
      <p><b>GOER</b>: регистр разрешения выходных данных (вывод <b>gpio_oe</b>) определяет направление передачи данных. При 0b1 выходные данные на соответствующем разряде <b>gpio_out</b> разрешены.</p>
      <p><b>GAFR</b>: регистр разрешения функции (вывод <b>gpio_en</b>) используется для управления выбором функции в случаях, когда один I/O совмещает в себе функции нескольких устройств. При 0b0 разрешена функция <b>GPIO</b>, при 0b1 - альтернативная функция.</p>
      <p><b>GPER</b>: регистр разрешения притяжки служит для разрешения включения притяжек в I/O. При 0b1 притяжка разрешена. Тип притяжки задается <b>GPTR</b>.</p>
      <p><b>GPTR</b>: регистр типа притяжки определяет тип притяжки (к "земле"/к "питанию") на соответствующем выводе I/O. При 0b1 включается притяжка к "питанию", при 0b0 - к "земле".</p>
      <p><b>GIER</b>: регистр разрешения прерываний служит для разрешения прерываний при изменении состояний на каждом из разрядов <b>GPIO</b>. Прерывание разрешено при 0b1.
      <p><b>GISR</b>: регистр типа источника прерывания определяет тип перепада на I/O, приводящий к генерации прерывания. Значение 0b0 определяет активным переключение из 1 в 0, значение 0b1 - из 0 в 1.</p>
      <p><b>GIFR</b>: регистр флагов прерываний содержит информацию о том, перепады на каких разрядах привели к генерации прерывания. Значение 0b1 в каком-либо из разрядов сигнализирует, что на этом выводе детектировано перепад, в соответствии со значениями <b>GCMR</b> и <b>GIER</b>. Регистр устанавливается при наступлении события, приводящего к генерации прерывания. Регистр сбрасывается при чтении.</p>
      <p><b>GDIR</b>: входной регистр данных содержит данные пришедшие с I/O. Если выбрана альтернативная функция (<b>GAFR</b> = 0b1), то соответствующие разряды регистра равны 0. Данные в регистр записываются по нарастающему фронту <b>clk</b>, с задержкой на 3 такта, если на соответствующем разряде используется фильтр (<b>META_ENA</b> равен 0b1).</p>
      <p><b>GCMR</b>: регистр выбора режима регистрации прерывания определяет по какому событию происходит генерация прерывания. Если равен 0b0, то по перепаду, определяемому <b>GISR</b>. Если равен 0b1, то прерывание генерируется по любому изменению состояния <b>gpio_in</b>.</p>
      <p><b>GFMR</b>: регистр выбора режима фильтрации входных данных. При 0b0 данные поступают в <b>GDIR</b> со схемы защиты от метастабильности (в соответствии с параметром <b>META_ENA</b>). При 0b1 значение регистра <b>GDIR</b> обновляется в случае регистрации одного и того же значения на выходе схемы защиты от метастабильности в течении 3 тактов <b>clk</b>.</p>
<!-- TODO: добавить рисунок с фильтрами и примером помех -->
<!-- TODO: сброс флагов по записи, чтобы параллельные процессы не затерли флаги опросом -->


      <h3>Мультиплексирование выводов</h3>
      <p>Для сокращения числа выводов микросхемы может быть использовано мультиплексирование нескольких функций на одном блоке I/O (например, <b>GPIO</b> и <b>uart</b>). За управление мультиплексированием отвечает регистр <b>GAFR</b> (вывод <b>gpio_en</b>). Если соответствующий бит регистра сброшен, то I/O выполняет функцию <b>GPIO</b> (<b>gpio_en</b> должен быть подключен к I/O соответствующим образом), если установлен, то альтернативную функцию (<b>uart</b>).</p>

      <h3>Режим приема данных</h3>
      <p>Для использования вывода <b>GPIO</b> в режиме приема данных следует сбросить соответствующий бит <b>GOER</b>. В регистре <b>GAFR</b> должен быть сброшен соответствующий бит для использования вывода в качестве функции <b>GPIO</b>. Входные данные записываются в регистр <b>GDIR</b> (вывод <b>gpio_in</b>). Если значение <b>GOER</b> или <b>GAFR</b> не соответствует указанным требованиям, то соответствующий разряд <b>GDIR</b> равен 0b0.</p>

      <h3>Режим передачи данных</h3>
      <p>Для использования вывода <b>GPIO</b> в режиме передачи данных следует установить соответствующий бит <b>GOER</b>. В регистре <b>GAFR</b> должен быть сброшен соответствующий бит для использования вывода в качестве функции <b>GPIO</b>. Передаваемые данные должны быть записаны в регистр <b>GDOR</b> и передаются через <b>gpio_out</b>. Если <b>GOER</b> равен 0b0, то вывод I/O должен находиться в 3-м состоянии или в режиме "открытого стока".</p>

      <h3>Режим притяжек</h3>
      <p>Для избавления от "плавающих" потенциалов в режиме приема могут быть использованы притяжки. Для разрешения притяжки следует установить бит <b>GPER</b> в 0b1. Для включения притяжки к "земле" следует сбросить бит <b>GPTR</b>, для включения притяжки к "питанию" - установить бит <b>GPTR</b>. Для сокращения энергопотребления в режиме передачи притяжки рекомендуется отключать.</p>

<!-- TODO: rewrite this chapter -- as new functionality made... -->
      <h3>Работа с прерываниями</h3>
      <p><b>GPIO</b> может генерировать прерывания при изменении состояния выводов. Для генерации прерывания должны быть выполнены следующие требования:
      <li> вывод сконфигурирован в режим приема (<b>GOER</b> равен 0b0);</li>
      <li> разрешено прерывание для разряда (<b>GIER</b> равен 0b1);</li>
      <li> выбрана функция <b>GPIO</b> для разряда (<b>GAFR</b> равен 0b0).</li>
      <p>Тип события, приводящего к генерации прерывания, определяется регистрами <b>GISR</b> и <b>GCMR</b>. Если <b>GCMR</b> равен 0b1, то прерывание генерируется по любому изменению на <b>gpio_in</b>. В противном случае, если <b>GISR</b> равен 0b1, то прерывание генерируется при переключении из 0 в 1 на <b>gpio_in</b>, если <b>GISR</b> равен 0b0, то при переключении из 1 в 0.</p>
      <p>При возникновении события, приводящего к генерации прерывания, устанавливается соответствующий бит <b>GIFR</b>. <b>GIFR</b> сбрасывается при чтении. Если одновременно происходят чтение регистра и установка его бит вследствие переключения на <b>gpio_in</b>, то прочитано будет текущее значение <b>GIFR</b>, сброшены все биты за исключением тех, к которым применяется установка.</p>
      <p>Сигнал <b>ifg</b> устанавливается, если в <b>GIFR</b> есть отличные от нуля разряды на следующем такте <b>clk</b>. Сбрасывается при чтении <b>GIFR</b>. Если одновременно с чтением <b>GIFR</b> происходит переключение на <b>gpio_in</b>, приводящее к генерации прерывания, то <b>ifg</b> сбрасывается и устанавливается на следующем такте <b>clk</b>.</p>
      <p> <img src="um_func_toggle_irq.png"></p>
      <b style="color: #ff0000"> Замечание.</b> Чтение регистра <b>GIFR</b> следует проводить после детектирования прерывания. В противном случае при чтении <b>GIFR</b> на следующем после установки <b>GIFR</b> такте не произойдет установки <b>ifg</b>. Информация об источнике прерывания не будет потеряна, но само прерывание не будет сигнализировано.
      <p> <img src="um_func_no_irq.png"></p>
      <p>Изменение на <b>gpio_in</b> регистрируется в <b>GDIR</b> с учетом задержки на 3 такта на входном фильтре, если он разрешен (<b>META_ENA</b> равен 0b1). Входной фильтр представляет собой сдвиговый регистр, используемый для защиты от метастабильности. Значение фильтра после сброса равно 0x0, поэтому рекомендуется запрещать прерывания (сбрасывать <b>GIER</b>) под воздействием сброса во избежание ложной генерации прерываний. Для сокращения энергопотребления фильтр (сдвиговый регистр) перестает сдвигать данные с <b>gpio_in</b>, если вывод сконфигурирован в режим передачи (<b>GDOR</b> равен 0b1) или в режим альтернативной функции (<b>GAFR</b> равен 0b1). Поэтому перед переключением в режим приема (сброс <b>GDOR</b>) и основной функции (<b>GAFR</b> равен 0b0) рекомендуется запрещать прерывание на соответствующем разряде и разрешать не ранее, чем через 4 такта <b>clk</b>, когда фильтр заполнится данными с <b>gpio_in</b>.</p>
      <p>Переключение на <b>gpio_in</b> не приведет к изменению соответствующего разряда <b>GIFR</b>, если он уже установлен.</p>

      <h3>Фильтрация помех</h3>
      <p>GPIO позволяет фильтровать помехи на входных линиях. Если бит <b>GFMR</b> установлен, то данные с выхода схемы защиты от метастабильности фильтруются по принципу длительности не менее 3 тактов.
         Выход фильтра изменяет свое значение на 1, если в течение предыдущих 3 тактов на <b>gpio_in</b> (с учетом задержки на схеме защиты от метастабильности) было захвачено значение 1. Аналогично для 0.
      </p>
      <p> <img src="um_filter.png"></p>
      <p>
         На рисунке приведен пример фильтрации значений на линии [4] (согласно настройке <b>GFMR</b>). При кратковременном переключении разрядов [3] и [4] из 0 в 1 в регистр <b>GDIR</b> поступают только изменения с линии [3].
         При последующем длительном импульсе на тех же линиях, оба значения поступают в <b>GDIR</b>, однако имеют разницу в задержке - 3 такта, используемые для фильтрации входного сигнала.
      </p>

   </body>
</html>
